generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String                       @id @default(cuid())
  clerkId              String                       @unique
  email                String                       @unique
  firstName            String?
  lastName             String?
  phone                String?
  company              String?
  role                 UserRole                     @default(USER)
  organizationId       String?
  createdAt            DateTime                     @default(now())
  updatedAt            DateTime                     @updatedAt
  devis                Devis[]
  orders               Order[]
  multicoucheTemplates PanneauMulticoucheTemplate[]
  organization         Organization?                @relation(fields: [organizationId], references: [id])

  @@index([clerkId])
  @@index([email])
}

model Organization {
  id               String   @id @default(cuid())
  name             String
  slug             String   @unique
  siret            String?
  address          String?
  city             String?
  postalCode       String?
  country          String   @default("FR")
  plan             PlanType @default(FREE)
  stripeCustomerId String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  devis            Devis[]
  orders           Order[]
  users            User[]

  @@index([slug])
}

model Catalogue {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  description String?
  logoUrl     String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  categories  Category[]
  panels      Panel[]

  @@index([slug])
}

model Category {
  id          String     @id @default(cuid())
  name        String
  slug        String
  parentId    String?
  catalogueId String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  catalogue   Catalogue  @relation(fields: [catalogueId], references: [id], onDelete: Cascade)
  parent      Category?  @relation("CategoryTree", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryTree")
  panels      Panel[]

  @@unique([catalogueId, slug])
  @@index([catalogueId])
  @@index([parentId])
  @@index([name])
}

model Panel {
  id               String      @id @default(cuid())
  reference        String
  name             String
  description      String?
  thickness        Float[]
  defaultLength    Int
  defaultWidth     Int
  pricePerM2       Float?
  pricePerPanel    Float?
  material         String?
  finish           String?
  colorCode        String?
  imageUrl         String?
  isActive         Boolean     @default(true)
  catalogueId      String
  categoryId       String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  stockStatus      String?
  certification    String?
  colorChoice      String?
  decor            String?
  defaultThickness Float?
  isVariableLength Boolean     @default(false)
  manufacturerRef  String?
  pricePerMl       Float?
  pricePerUnit     Float?
  productType      String?
  stockLocations   String?
  supplierCode     String?
  supportQuality   String?
  metadata         String?
  devisLines       DevisLine[]
  catalogue        Catalogue   @relation(fields: [catalogueId], references: [id], onDelete: Cascade)
  category         Category?   @relation(fields: [categoryId], references: [id])

  @@unique([catalogueId, reference])
  @@index([catalogueId])
  @@index([reference])
  @@index([name])
  @@index([isActive])
  @@index([categoryId])
  @@index([catalogueId, isActive])
  @@index([finish])
}

model Devis {
  id             String        @id @default(cuid())
  reference      String        @unique
  name           String?
  status         DevisStatus   @default(DRAFT)
  clientName     String?
  clientEmail    String?
  clientPhone    String?
  clientAddress  String?
  totalHT        Float         @default(0)
  totalTVA       Float         @default(0)
  totalTTC       Float         @default(0)
  tvaRate        Float         @default(20)
  notes          String?
  validUntil     DateTime?
  userId         String
  organizationId String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization? @relation(fields: [organizationId], references: [id])
  user           User          @relation(fields: [userId], references: [id])
  lines          DevisLine[]
  order          Order?

  @@index([userId])
  @@index([reference])
  @@index([status])
}

model DevisLine {
  id             String   @id @default(cuid())
  panelReference String
  panelName      String
  thickness      Float
  length         Int
  width          Int
  quantity       Int      @default(1)
  chantHaut      String?
  chantBas       String?
  chantGauche    String?
  chantDroit     String?
  unitPriceHT    Float
  totalHT        Float
  position       Int      @default(0)
  devisId        String
  panelId        String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  devis          Devis    @relation(fields: [devisId], references: [id], onDelete: Cascade)
  panel          Panel?   @relation(fields: [panelId], references: [id])

  @@index([devisId])
}

model Order {
  id                String        @id @default(cuid())
  reference         String        @unique
  status            OrderStatus   @default(PENDING)
  totalHT           Float
  totalTVA          Float
  totalTTC          Float
  stripePaymentId   String?
  paidAt            DateTime?
  deliveryAddress   String?
  deliveryNotes     String?
  estimatedDelivery DateTime?
  deliveredAt       DateTime?
  userId            String
  organizationId    String?
  devisId           String        @unique
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  devis             Devis         @relation(fields: [devisId], references: [id])
  organization      Organization? @relation(fields: [organizationId], references: [id])
  user              User          @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([reference])
  @@index([status])
}

model PanneauMulticoucheTemplate {
  id              String   @id @default(cuid())
  nom             String
  description     String?
  modeCollage     String
  couches         String
  epaisseurTotale Float
  prixEstimeM2    Float
  userId          String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model CutxImportSession {
  id              String    @id @default(cuid())
  data            String
  projectName     String?
  sketchupVersion String?
  pluginVersion   String?
  ipAddress       String?
  expiresAt       DateTime
  usedAt          DateTime?
  createdAt       DateTime  @default(now())

  @@index([expiresAt])
  @@index([createdAt])
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum PlanType {
  FREE
  PRO
  ENTERPRISE
}

enum DevisStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
  CONVERTED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

// ============================================
// QUINCAILLERIE & CAISSONS
// ============================================

// Catalogue de quincaillerie (ferrures)
model Fitting {
  id              String             @id @default(cuid())
  reference       String             @unique
  name            String
  brand           FittingBrand
  category        FittingCategory

  // Donnees techniques
  drillingPattern String?            // JSON: pattern de percage
  mountingData    String?            // JSON: donnees installation
  specifications  String?            // JSON: specs techniques

  // Compatibilite panneaux
  minThickness    Float?             // Epaisseur min panneau (mm)
  maxThickness    Float?             // Epaisseur max panneau (mm)

  // Dimensions
  angle           Int?               // Angle ouverture (charnieres)
  length          Float?             // Longueur (coulisses)

  // Prix
  priceHT         Float
  priceUnit       String             @default("piece")

  // Media
  imageUrl        String?
  documentUrl     String?            // Fiche technique PDF
  cadFileUrl      String?            // Fichier CAD/DXF

  // Relations
  accessories     FittingAccessory[]
  cabinetFittings CabinetFitting[]

  isActive        Boolean            @default(true)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([brand])
  @@index([category])
  @@index([isActive])
}

// Accessoires lies a une ferrure (embase, cache, vis...)
model FittingAccessory {
  id          String   @id @default(cuid())
  reference   String
  name        String
  priceHT     Float
  quantity    Int      @default(1)  // Quantite par ferrure principale
  isRequired  Boolean  @default(true)

  fittingId   String
  fitting     Fitting  @relation(fields: [fittingId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@index([fittingId])
}

// Template de caisson (modeles predefinis)
model CabinetTemplate {
  id          String      @id @default(cuid())
  name        String
  description String?
  type        CabinetType
  source      String      @default("custom")  // blum, hettich, custom

  // Dimensions par defaut (mm)
  defaultWidth    Int
  defaultHeight   Int
  defaultDepth    Int

  // Contraintes dimensions (mm)
  minWidth    Int         @default(100)
  maxWidth    Int         @default(1200)
  minHeight   Int         @default(200)
  maxHeight   Int         @default(2800)
  minDepth    Int         @default(100)
  maxDepth    Int         @default(800)

  // Epaisseurs par defaut (mm)
  defaultStructureThickness Float   @default(19)
  defaultBackThickness      Float   @default(8)
  defaultDoorThickness      Float   @default(19)

  // Configuration par defaut
  defaultBackType   BackType    @default(APPLIQUE)
  defaultDoorType   DoorType    @default(APPLIQUE)

  imageUrl    String?

  // Relations
  cabinets    Cabinet[]

  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([type])
  @@index([isActive])
}

// Caisson configure
model Cabinet {
  id          String          @id @default(cuid())
  name        String

  // Template source (optionnel)
  templateId  String?
  template    CabinetTemplate? @relation(fields: [templateId], references: [id])

  // Dimensions (mm)
  width       Int
  height      Int
  depth       Int

  // Epaisseurs (mm)
  structureThickness Float
  backThickness      Float
  doorThickness      Float?

  // Configuration
  backType    BackType
  doorType    DoorType?
  hasDoor     Boolean         @default(true)
  doorGap     Float           @default(1.5)  // Jeu facade (mm)

  // Charnieres
  hingePosition String?       // gauche, droite
  hingeCount    Int?

  // Panneaux generes
  panels      CabinetPanel[]

  // Quincaillerie
  fittings    CabinetFitting[]

  // Percages calcules
  drillings   CabinetDrilling[]

  // Prix calcules
  totalPanelsHT    Float       @default(0)
  totalEdgingHT    Float       @default(0)
  totalFittingsHT  Float       @default(0)
  totalDrillingHT  Float       @default(0)
  totalHT          Float       @default(0)

  // Lien vers devis (optionnel)
  devisId     String?
  userId      String?

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([templateId])
  @@index([userId])
}

// Panneau d'un caisson
model CabinetPanel {
  id          String   @id @default(cuid())

  cabinetId   String
  cabinet     Cabinet  @relation(fields: [cabinetId], references: [id], onDelete: Cascade)

  // Type et nom
  type        PanelType
  name        String          // "Cote gauche", "Panneau superieur"...
  shortName   String?         // "CG", "PS"...

  // Dimensions (mm)
  length      Float
  width       Float
  thickness   Float

  // Surface
  surfaceM2       Float
  surfaceCharged  Float       // Avec minimum 0.25m2

  // Chants (true = chant applique)
  edgeA       Boolean         @default(false)  // Longueur cote 1
  edgeB       Boolean         @default(false)  // Largeur cote 1
  edgeC       Boolean         @default(false)  // Longueur cote 2
  edgeD       Boolean         @default(false)  // Largeur cote 2
  edgeMeters  Float           @default(0)      // Total metres lineaires

  // Percages sur ce panneau
  drillings   CabinetDrilling[]

  // Reference panneau catalogue (optionnel)
  panelId     String?

  createdAt   DateTime        @default(now())

  @@index([cabinetId])
  @@index([type])
}

// Percage sur un panneau de caisson
model CabinetDrilling {
  id          String        @id @default(cuid())

  cabinetId   String
  cabinet     Cabinet       @relation(fields: [cabinetId], references: [id], onDelete: Cascade)

  panelId     String
  panel       CabinetPanel  @relation(fields: [panelId], references: [id], onDelete: Cascade)

  // Position sur le panneau (mm depuis coin bas-gauche)
  x           Float
  y           Float

  // Caracteristiques du trou
  diameter    Float         // mm
  depth       Float         // mm
  type        DrillingType  @default(BLIND)

  // Origine du percage
  source      DrillingSource @default(SYSTEM32)

  // Lie a une ferrure (optionnel)
  fittingId   String?
  fittingName String?

  @@index([cabinetId])
  @@index([panelId])
}

// Ferrure utilisee dans un caisson
model CabinetFitting {
  id          String   @id @default(cuid())

  cabinetId   String
  cabinet     Cabinet  @relation(fields: [cabinetId], references: [id], onDelete: Cascade)

  fittingId   String
  fitting     Fitting  @relation(fields: [fittingId], references: [id])

  quantity    Int
  position    String?       // gauche, droite, haut, bas

  // Prix (copie au moment de l'ajout)
  unitPriceHT Float
  totalHT     Float

  @@index([cabinetId])
  @@index([fittingId])
}

// === ENUMS QUINCAILLERIE ===

enum FittingBrand {
  BLUM
  HETTICH
  HAFELE
  GRASS
  SALICE
  OTHER
}

enum FittingCategory {
  HINGE              // Charnieres
  DRAWER_RUNNER      // Coulisses tiroirs
  SHELF_SUPPORT      // Supports etageres
  CONNECTOR          // Connecteurs (excentrique, tourillon)
  LIFT_SYSTEM        // Relevables (AVENTOS)
  DAMPER             // Amortisseurs
  SLIDE              // Glissieres
}

enum CabinetType {
  BASE               // Bas cuisine
  WALL               // Haut mural
  TALL               // Colonne
  DRAWER             // Tiroirs
  CORNER             // Angle
  CUSTOM             // Libre
}

enum BackType {
  APPLIQUE           // Fond en applique (visse derriere)
  GROOVE             // Fond dans rainure
  REBATE             // Fond en feuillure
}

enum DoorType {
  APPLIQUE           // Facade recouvre les cotes
  INSET              // Facade entre les cotes
}

enum PanelType {
  LEFT_SIDE          // Cote gauche
  RIGHT_SIDE         // Cote droit
  TOP                // Dessus
  BOTTOM             // Dessous
  BACK               // Fond
  DOOR               // Porte/Facade
  SHELF              // Etagere
  DRAWER_FRONT       // Face tiroir
}

enum DrillingType {
  BLIND              // Borgne (ne traverse pas)
  THROUGH            // Traversant
}

enum DrillingSource {
  SYSTEM32           // Percage System 32 (etageres)
  HINGE              // Percage charniere
  CONNECTOR          // Percage connecteur
  DRAWER_RUNNER      // Percage coulisse
  CUSTOM             // Percage manuel/custom
}

// ============================================
// USINAGES (Module Usinage)
// ============================================

// Template d'usinage configurable par l'admin
model UsinageTemplate {
  id              String              @id @default(cuid())

  // Identification
  nom             String              // Ex: "Rainure traversante"
  slug            String              @unique // Ex: "rainure-traversante"
  description     String?             @db.Text // Explication/aide

  // Icone SVG (code complet inline)
  iconSvg         String              @db.Text

  // Schema de configuration (parametres requis)
  // JSON: [{ key: "longueur", label: "Longueur", unit: "mm", required: true, min: 0, max: 5000 }, ...]
  configSchema    String              @db.Text

  // SVG technique pour dessin cote (optionnel)
  // JSON: { viewBox: "0 0 200 200", elements: [...], dimensions: [...] }
  technicalSvg    String?             @db.Text

  // Tarification
  pricingType     UsinagePricingType
  priceHT         Float               // Prix de base

  // Categorie pour organisation
  category        UsinageCategory?

  // Ordre d'affichage
  sortOrder       Int                 @default(0)

  // Active/Inactive
  isActive        Boolean             @default(true)

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([isActive])
  @@index([category])
  @@index([sortOrder])
}

enum UsinagePricingType {
  PER_UNIT        // Par unite
  PER_METER       // Par metre lineaire
  PER_M2          // Par metre carre
  FIXED           // Prix fixe
}

enum UsinageCategory {
  RAINURE         // Rainures
  PERCAGE         // Percages
  USINAGE_CN      // Usinages CNC
  DEFONCEUSE      // Defonceuse
  PASSE_MAIN      // Passe-main
  AUTRE           // Autres
}
