generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String                       @id @default(cuid())
  clerkId              String                       @unique
  email                String                       @unique
  firstName            String?
  lastName             String?
  phone                String?
  company              String?
  role                 UserRole                     @default(USER)
  organizationId       String?
  createdAt            DateTime                     @default(now())
  updatedAt            DateTime                     @updatedAt
  devis                Devis[]
  orders               Order[]
  multicoucheTemplates PanneauMulticoucheTemplate[]
  organization         Organization?                @relation(fields: [organizationId], references: [id])

  @@index([clerkId])
  @@index([email])
}

model Organization {
  id               String   @id @default(cuid())
  name             String
  slug             String   @unique
  siret            String?
  address          String?
  city             String?
  postalCode       String?
  country          String   @default("FR")
  plan             PlanType @default(FREE)
  stripeCustomerId String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  devis            Devis[]
  orders           Order[]
  users            User[]

  @@index([slug])
}

model Catalogue {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  description String?
  logoUrl     String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  categories  Category[]
  panels      Panel[]

  @@index([slug])
}

model Category {
  id          String     @id @default(cuid())
  name        String
  slug        String
  parentId    String?
  catalogueId String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  catalogue   Catalogue  @relation(fields: [catalogueId], references: [id], onDelete: Cascade)
  parent      Category?  @relation("CategoryTree", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryTree")
  panels      Panel[]

  @@unique([catalogueId, slug])
  @@index([catalogueId])
  @@index([parentId])
  @@index([name])
}

model Panel {
  id               String            @id @default(cuid())
  reference        String
  name             String
  description      String?
  thickness        Float[]
  defaultLength    Int
  defaultWidth     Int
  pricePerM2       Float?
  pricePerPanel    Float?
  material         String?
  finish           String?
  colorCode        String?
  imageUrl         String?
  isActive         Boolean           @default(true)
  catalogueId      String
  categoryId       String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  stockStatus      String?
  certification    String?
  colorChoice      String?
  decor            String?
  defaultThickness Float?
  isVariableLength Boolean           @default(false)
  manufacturerRef  String?
  pricePerMl       Float?
  pricePerUnit     Float?
  productType      String?
  stockLocations   String?
  supplierCode     String?
  supportQuality   String?
  metadata         String?
  isSponsored      Boolean           @default(false)
  sponsoredUntil   DateTime?
  reviewStatus     PanelReviewStatus @default(NON_VERIFIE)
  reviewedAt       DateTime?
  reviewedBy       String?
  coreColor        CoreColor?
  coreType         CoreType?
  decorCategory    DecorCategory?
  decorCode        String?
  decorName        String?
  decorSubCategory String?
  finishCode       String?
  finishName       String?
  grainDirection   GrainDirection?
  isHydrofuge      Boolean           @default(false)
  isIgnifuge       Boolean           @default(false)
  isPreglued       Boolean           @default(false)
  isSynchronized   Boolean           @default(false)
  isFullRoll       Boolean           @default(false)  // Vente en rouleau complet (pas au mètre)
  lamellaType      LamellaType?
  manufacturer     String?
  viewCount        Int               @default(0)     // Total des vues
  weeklyViews      Int               @default(0)     // Vues de la semaine (reset hebdo)
  lastViewedAt     DateTime?                         // Dernière vue
  panelSubType     ProductSubType?
  panelType        ProductType?
  productCategory  ProductCategory?
  // Full-text search columns (managed by PostgreSQL triggers)
  searchVector     Unsupported("tsvector")?
  searchText       String?
  devisLines       DevisLine[]
  catalogue        Catalogue         @relation(fields: [catalogueId], references: [id], onDelete: Cascade)
  category         Category?         @relation(fields: [categoryId], references: [id])

  @@unique([catalogueId, reference])
  @@index([catalogueId])
  @@index([reference])
  @@index([name])
  @@index([isActive])
  @@index([categoryId])
  @@index([catalogueId, isActive])
  @@index([finish])
  @@index([isSponsored])
  @@index([reviewStatus])
  @@index([decorCode])
  @@index([decorCategory])
  @@index([panelType])
  @@index([manufacturer])
  @@index([viewCount(sort: Desc)])
  @@index([weeklyViews(sort: Desc)])
}

model Devis {
  id             String        @id @default(cuid())
  reference      String        @unique
  name           String?
  status         DevisStatus   @default(DRAFT)
  clientName     String?
  clientEmail    String?
  clientPhone    String?
  clientAddress  String?
  totalHT        Float         @default(0)
  totalTVA       Float         @default(0)
  totalTTC       Float         @default(0)
  tvaRate        Float         @default(20)
  notes          String?
  validUntil     DateTime?
  userId         String
  organizationId String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization? @relation(fields: [organizationId], references: [id])
  user           User          @relation(fields: [userId], references: [id])
  lines          DevisLine[]
  order          Order?

  @@index([userId])
  @@index([reference])
  @@index([status])
}

model DevisLine {
  id             String   @id @default(cuid())
  panelReference String
  panelName      String
  thickness      Float
  length         Int
  width          Int
  quantity       Int      @default(1)
  chantHaut      String?
  chantBas       String?
  chantGauche    String?
  chantDroit     String?
  unitPriceHT    Float
  totalHT        Float
  position       Int      @default(0)
  devisId        String
  panelId        String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  devis          Devis    @relation(fields: [devisId], references: [id], onDelete: Cascade)
  panel          Panel?   @relation(fields: [panelId], references: [id])

  @@index([devisId])
}

model Order {
  id                String        @id @default(cuid())
  reference         String        @unique
  status            OrderStatus   @default(PENDING)
  totalHT           Float
  totalTVA          Float
  totalTTC          Float
  stripePaymentId   String?
  paidAt            DateTime?
  deliveryAddress   String?
  deliveryNotes     String?
  estimatedDelivery DateTime?
  deliveredAt       DateTime?
  userId            String
  organizationId    String?
  devisId           String        @unique
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  devis             Devis         @relation(fields: [devisId], references: [id])
  organization      Organization? @relation(fields: [organizationId], references: [id])
  user              User          @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([reference])
  @@index([status])
}

model PanneauMulticoucheTemplate {
  id              String   @id @default(cuid())
  nom             String
  description     String?
  modeCollage     String
  couches         String
  epaisseurTotale Float
  prixEstimeM2    Float
  userId          String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model CutxImportSession {
  id              String    @id @default(cuid())
  data            String
  projectName     String?
  sketchupVersion String?
  pluginVersion   String?
  ipAddress       String?
  expiresAt       DateTime
  usedAt          DateTime?
  createdAt       DateTime  @default(now())

  @@index([expiresAt])
  @@index([createdAt])
}

// Rate limiting pour le tracking des vues (éviter le spam)
model PanelViewLog {
  id        String   @id @default(cuid())
  panelId   String
  viewerKey String   // Hash IP ou UserId
  viewedAt  DateTime @default(now())

  @@unique([panelId, viewerKey])
  @@index([viewedAt])
  @@index([panelId])
}

model Fitting {
  id              String             @id @default(cuid())
  reference       String             @unique
  name            String
  brand           FittingBrand
  category        FittingCategory
  drillingPattern String?
  mountingData    String?
  specifications  String?
  minThickness    Float?
  maxThickness    Float?
  angle           Int?
  length          Float?
  priceHT         Float
  priceUnit       String             @default("piece")
  imageUrl        String?
  documentUrl     String?
  cadFileUrl      String?
  isActive        Boolean            @default(true)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  cabinetFittings CabinetFitting[]
  accessories     FittingAccessory[]

  @@index([brand])
  @@index([category])
  @@index([isActive])
}

model FittingAccessory {
  id         String   @id @default(cuid())
  reference  String
  name       String
  priceHT    Float
  quantity   Int      @default(1)
  isRequired Boolean  @default(true)
  fittingId  String
  createdAt  DateTime @default(now())
  fitting    Fitting  @relation(fields: [fittingId], references: [id], onDelete: Cascade)

  @@index([fittingId])
}

model CabinetTemplate {
  id                        String      @id @default(cuid())
  name                      String
  description               String?
  type                      CabinetType
  source                    String      @default("custom")
  defaultWidth              Int
  defaultHeight             Int
  defaultDepth              Int
  minWidth                  Int         @default(100)
  maxWidth                  Int         @default(1200)
  minHeight                 Int         @default(200)
  maxHeight                 Int         @default(2800)
  minDepth                  Int         @default(100)
  maxDepth                  Int         @default(800)
  defaultStructureThickness Float       @default(19)
  defaultBackThickness      Float       @default(8)
  defaultDoorThickness      Float       @default(19)
  defaultBackType           BackType    @default(APPLIQUE)
  defaultDoorType           DoorType    @default(APPLIQUE)
  imageUrl                  String?
  isActive                  Boolean     @default(true)
  createdAt                 DateTime    @default(now())
  updatedAt                 DateTime    @updatedAt
  cabinets                  Cabinet[]

  @@index([type])
  @@index([isActive])
}

model Cabinet {
  id                 String            @id @default(cuid())
  name               String
  templateId         String?
  width              Int
  height             Int
  depth              Int
  structureThickness Float
  backThickness      Float
  doorThickness      Float?
  backType           BackType
  doorType           DoorType?
  hasDoor            Boolean           @default(true)
  doorGap            Float             @default(1.5)
  hingePosition      String?
  hingeCount         Int?
  totalPanelsHT      Float             @default(0)
  totalEdgingHT      Float             @default(0)
  totalFittingsHT    Float             @default(0)
  totalDrillingHT    Float             @default(0)
  totalHT            Float             @default(0)
  devisId            String?
  userId             String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  template           CabinetTemplate?  @relation(fields: [templateId], references: [id])
  drillings          CabinetDrilling[]
  fittings           CabinetFitting[]
  panels             CabinetPanel[]

  @@index([templateId])
  @@index([userId])
}

model CabinetPanel {
  id             String            @id @default(cuid())
  cabinetId      String
  type           PanelType
  name           String
  shortName      String?
  length         Float
  width          Float
  thickness      Float
  surfaceM2      Float
  surfaceCharged Float
  edgeA          Boolean           @default(false)
  edgeB          Boolean           @default(false)
  edgeC          Boolean           @default(false)
  edgeD          Boolean           @default(false)
  edgeMeters     Float             @default(0)
  panelId        String?
  createdAt      DateTime          @default(now())
  drillings      CabinetDrilling[]
  cabinet        Cabinet           @relation(fields: [cabinetId], references: [id], onDelete: Cascade)

  @@index([cabinetId])
  @@index([type])
}

model CabinetDrilling {
  id          String         @id @default(cuid())
  cabinetId   String
  panelId     String
  x           Float
  y           Float
  diameter    Float
  depth       Float
  type        DrillingType   @default(BLIND)
  source      DrillingSource @default(SYSTEM32)
  fittingId   String?
  fittingName String?
  cabinet     Cabinet        @relation(fields: [cabinetId], references: [id], onDelete: Cascade)
  panel       CabinetPanel   @relation(fields: [panelId], references: [id], onDelete: Cascade)

  @@index([cabinetId])
  @@index([panelId])
}

model CabinetFitting {
  id          String  @id @default(cuid())
  cabinetId   String
  fittingId   String
  quantity    Int
  position    String?
  unitPriceHT Float
  totalHT     Float
  cabinet     Cabinet @relation(fields: [cabinetId], references: [id], onDelete: Cascade)
  fitting     Fitting @relation(fields: [fittingId], references: [id])

  @@index([cabinetId])
  @@index([fittingId])
}

model UsinageTemplate {
  id           String             @id @default(cuid())
  nom          String
  slug         String             @unique
  description  String?
  iconSvg      String
  configSchema String
  technicalSvg String?
  pricingType  UsinagePricingType
  priceHT      Float
  category     UsinageCategory?
  sortOrder    Int                @default(0)
  isActive     Boolean            @default(true)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  @@index([isActive])
  @@index([category])
  @@index([sortOrder])
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum PlanType {
  FREE
  PRO
  ENTERPRISE
}

enum DevisStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
  CONVERTED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum FittingBrand {
  BLUM
  HETTICH
  HAFELE
  GRASS
  SALICE
  OTHER
}

enum FittingCategory {
  HINGE
  DRAWER_RUNNER
  SHELF_SUPPORT
  CONNECTOR
  LIFT_SYSTEM
  DAMPER
  SLIDE
}

enum CabinetType {
  BASE
  WALL
  TALL
  DRAWER
  CORNER
  CUSTOM
}

enum BackType {
  APPLIQUE
  GROOVE
  REBATE
}

enum DoorType {
  APPLIQUE
  INSET
}

enum PanelType {
  LEFT_SIDE
  RIGHT_SIDE
  TOP
  BOTTOM
  BACK
  DOOR
  SHELF
  DRAWER_FRONT
}

enum DrillingType {
  BLIND
  THROUGH
}

enum DrillingSource {
  SYSTEM32
  HINGE
  CONNECTOR
  DRAWER_RUNNER
  CUSTOM
}

enum UsinagePricingType {
  PER_UNIT
  PER_METER
  PER_M2
  FIXED
}

enum UsinageCategory {
  RAINURE
  PERCAGE
  USINAGE_CN
  DEFONCEUSE
  PASSE_MAIN
  AUTRE
}

enum PanelReviewStatus {
  NON_VERIFIE
  VERIFIE
  A_CORRIGER
}

enum ProductCategory {
  PANNEAU
  ACCESSOIRE
}

enum ProductType {
  MELAMINE
  STRATIFIE
  COMPACT
  PLACAGE
  AGGLO_BRUT
  MDF
  CONTREPLAQUE
  OSB
  MASSIF
  CHANT
  SOLID_SURFACE
  PANNEAU_DECO    // Panneaux décoratifs (fraisés 3D, texturés, etc.)
}

enum ProductSubType {
  HPL
  CPL
  CHANT_ABS
  CHANT_PVC
  CHANT_MELAMINE
  CHANT_BOIS
  MDF_BRUT
  MDF_LAQUE
  MDF_PLAQUE
  MASSIF_BOIS
  MASSIF_3_PLIS
  LAMELLE_COLLE
  SS_ACRYLIQUE
  SS_POLYESTER
  SS_QUARTZ
}

enum DecorCategory {
  UNIS
  BOIS
  PIERRE
  BETON
  METAL
  TEXTILE
  FANTAISIE
  SANS_DECOR
}

enum GrainDirection {
  LENGTH
  WIDTH
  NONE
}

enum CoreType {
  P2
  P3
  MDF_STD
  MDF_H
  MDF_FR
  CONTREPLAQUE
  AUCUN
}

enum CoreColor {
  WHITE
  GRAY
  YELLOW
  BROWN
  BLACK
  STANDARD
}

enum LamellaType {
  ABOUTE       // Lamelles aboutées (finger-jointed) - moins cher
  NON_ABOUTE   // Lamelles continues (solid) - plus noble
}
