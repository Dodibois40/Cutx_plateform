// CutX Platform - Prisma Schema
// PostgreSQL database on Railway

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USERS & ORGANIZATIONS
// ============================================

model User {
  id            String    @id @default(cuid())
  clerkId       String    @unique // Clerk user ID
  email         String    @unique
  firstName     String?
  lastName      String?
  phone         String?
  company       String?
  role          UserRole  @default(USER)

  // Relations
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  devis          Devis[]
  orders         Order[]
  multicoucheTemplates PanneauMulticoucheTemplate[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([clerkId])
  @@index([email])
}

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  siret       String?
  address     String?
  city        String?
  postalCode  String?
  country     String   @default("FR")

  // Relations
  users       User[]
  devis       Devis[]
  orders      Order[]

  // Subscription
  plan        PlanType @default(FREE)
  stripeCustomerId String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([slug])
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum PlanType {
  FREE
  PRO
  ENTERPRISE
}

// ============================================
// CATALOGUES & PANELS
// ============================================

model Catalogue {
  id          String   @id @default(cuid())
  name        String   // "Bouney", "Egger", etc.
  slug        String   @unique
  description String?
  logoUrl     String?
  isActive    Boolean  @default(true)

  // Relations
  categories  Category[]
  panels      Panel[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([slug])
}

model Category {
  id          String   @id @default(cuid())
  name        String   // "Mélaminés", "Stratifiés", etc.
  slug        String
  parentId    String?
  parent      Category?  @relation("CategoryTree", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryTree")

  // Relations
  catalogueId String
  catalogue   Catalogue @relation(fields: [catalogueId], references: [id], onDelete: Cascade)
  panels      Panel[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([catalogueId, slug])
  @@index([catalogueId])
  @@index([parentId])
  @@index([name])
}

model Panel {
  id              String   @id @default(cuid())
  reference       String   // Code fournisseur (79133)
  name            String   // Nom commercial complet
  description     String?

  // Identification fabricant
  manufacturerRef String?  // Référence fabricant (005)
  supplierCode    String?  // Code fournisseur (redondant avec reference pour clarté)

  // Dimensions disponibles
  thickness       Float[]  // Épaisseurs dispo en mm [8, 16, 19, 22]
  defaultThickness Float?  // Épaisseur par défaut
  defaultLength   Int      // Longueur standard en mm
  defaultWidth    Int      // Largeur standard en mm
  isVariableLength Boolean @default(false) // Pour les chants avec longueur variable

  // Prix
  pricePerM2      Float?   // Prix au m²
  pricePerMl      Float?   // Prix au mètre linéaire (chants)
  pricePerUnit    Float?   // Prix unitaire
  pricePerPanel   Float?   // Prix par panneau

  // Caractéristiques techniques
  material        String?  // MDF, Agglo, Contreplaqué, etc.
  supportQuality  String?  // "panneau de particules standard P2", "hpl", etc.
  finish          String?  // Mat, Brillant, Texturé, FA, etc.
  productType     String?  // MELAMINE, STRATIFIE, BANDE_DE_CHANT, COMPACT

  // Décor et couleur
  decor           String?  // Décor/Essence (unis, bois, matières)
  colorCode       String?  // Code couleur (005)
  colorChoice     String?  // Coloris/Choix descriptif

  // Certification et qualité
  certification   String?  // "PEFC 70%", "FSC", etc.

  imageUrl        String?

  // Stock détaillé
  stockStatus     String?  // "EN STOCK", "Sur commande"
  stockLocations  String?  // JSON: [{"location":"Bouney, Anglet","inStock":true}]

  // Métadonnées étendues (JSON) - pour données supplémentaires fournisseur
  // Ex Dispano: refMarque, codeEAN, poids, classeFeu, CO2, etc.
  metadata        String?  // JSON stringifié

  isActive        Boolean  @default(true)

  // Relations
  catalogueId     String
  catalogue       Catalogue @relation(fields: [catalogueId], references: [id], onDelete: Cascade)
  categoryId      String?
  category        Category? @relation(fields: [categoryId], references: [id])
  devisLines      DevisLine[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([catalogueId, reference])
  @@index([catalogueId])
  @@index([reference])
  // Index pour optimiser les recherches
  @@index([name])
  @@index([isActive])
  @@index([categoryId])
  @@index([catalogueId, isActive])
  @@index([finish]) // Pour recherche par marque
}

// ============================================
// DEVIS (QUOTES)
// ============================================

model Devis {
  id              String      @id @default(cuid())
  reference       String      @unique // DEV-2024-001
  name            String?     // Nom du projet
  status          DevisStatus @default(DRAFT)

  // Client info
  clientName      String?
  clientEmail     String?
  clientPhone     String?
  clientAddress   String?

  // Totals
  totalHT         Float       @default(0)
  totalTVA        Float       @default(0)
  totalTTC        Float       @default(0)
  tvaRate         Float       @default(20)

  // Metadata
  notes           String?
  validUntil      DateTime?

  // Relations
  userId          String
  user            User        @relation(fields: [userId], references: [id])
  organizationId  String?
  organization    Organization? @relation(fields: [organizationId], references: [id])
  lines           DevisLine[]
  order           Order?

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([userId])
  @@index([reference])
  @@index([status])
}

model DevisLine {
  id              String   @id @default(cuid())

  // Panel info (snapshot at creation time)
  panelReference  String
  panelName       String
  thickness       Float    // Épaisseur choisie

  // Dimensions pièce
  length          Int      // Longueur en mm
  width           Int      // Largeur en mm
  quantity        Int      @default(1)

  // Chants
  chantHaut       String?  // Type de chant (ABS 1mm, etc.)
  chantBas        String?
  chantGauche     String?
  chantDroit      String?

  // Prix
  unitPriceHT     Float
  totalHT         Float

  // Position
  position        Int      @default(0)

  // Relations
  devisId         String
  devis           Devis    @relation(fields: [devisId], references: [id], onDelete: Cascade)
  panelId         String?
  panel           Panel?   @relation(fields: [panelId], references: [id])

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([devisId])
}

enum DevisStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
  CONVERTED
}

// ============================================
// ORDERS
// ============================================

model Order {
  id              String      @id @default(cuid())
  reference       String      @unique // ORD-2024-001
  status          OrderStatus @default(PENDING)

  // Amounts
  totalHT         Float
  totalTVA        Float
  totalTTC        Float

  // Payment
  stripePaymentId String?
  paidAt          DateTime?

  // Delivery
  deliveryAddress String?
  deliveryNotes   String?
  estimatedDelivery DateTime?
  deliveredAt     DateTime?

  // Relations
  userId          String
  user            User        @relation(fields: [userId], references: [id])
  organizationId  String?
  organization    Organization? @relation(fields: [organizationId], references: [id])
  devisId         String      @unique
  devis           Devis       @relation(fields: [devisId], references: [id])

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([userId])
  @@index([reference])
  @@index([status])
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

// ============================================
// PANNEAU MULTICOUCHE TEMPLATES
// ============================================

model PanneauMulticoucheTemplate {
  id              String   @id @default(cuid())
  nom             String   // Nom du template donné par l'utilisateur
  description     String?  // Description optionnelle

  // Données du panneau multicouche (stockées en JSON)
  modeCollage     String   // 'fournisseur' | 'client'
  couches         String   // JSON array des CoucheMulticouche
  epaisseurTotale Float    // Épaisseur totale calculée
  prixEstimeM2    Float    // Prix estimé au m²

  // Ownership
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
}

// ============================================
// CUTX IMPORT SESSIONS (Plugin SketchUp)
// ============================================

model CutxImportSession {
  id              String    @id @default(cuid())
  data            String    // JSON des panneaux (dimensions, chants, finition, DXF...)
  projectName     String?
  sketchupVersion String?
  pluginVersion   String?
  ipAddress       String?
  expiresAt       DateTime  // TTL de 1 heure
  usedAt          DateTime? // Marqué quand récupéré
  createdAt       DateTime  @default(now())

  @@index([expiresAt])
  @@index([createdAt])
}
