generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String                       @id @default(cuid())
  clerkId              String                       @unique
  email                String                       @unique
  firstName            String?
  lastName             String?
  phone                String?
  company              String?
  role                 UserRole                     @default(USER)
  organizationId       String?
  createdAt            DateTime                     @default(now())
  updatedAt            DateTime                     @updatedAt
  devis                Devis[]
  orders               Order[]
  multicoucheTemplates PanneauMulticoucheTemplate[]
  organization         Organization?                @relation(fields: [organizationId], references: [id])

  @@index([clerkId])
  @@index([email])
}

model Organization {
  id               String   @id @default(cuid())
  name             String
  slug             String   @unique
  siret            String?
  address          String?
  city             String?
  postalCode       String?
  country          String   @default("FR")
  plan             PlanType @default(FREE)
  stripeCustomerId String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  devis            Devis[]
  orders           Order[]
  users            User[]

  @@index([slug])
}

model Catalogue {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  description String?
  logoUrl     String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  categories  Category[]
  panels      Panel[]

  @@index([slug])
}

model Category {
  id          String     @id @default(cuid())
  name        String
  slug        String
  parentId    String?
  catalogueId String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  catalogue   Catalogue  @relation(fields: [catalogueId], references: [id], onDelete: Cascade)
  parent      Category?  @relation("CategoryTree", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryTree")
  panels      Panel[]

  @@unique([catalogueId, slug])
  @@index([catalogueId])
  @@index([parentId])
  @@index([name])
}

model Panel {
  id               String      @id @default(cuid())
  reference        String
  name             String
  description      String?
  thickness        Float[]
  defaultLength    Int
  defaultWidth     Int
  pricePerM2       Float?
  pricePerPanel    Float?
  material         String?
  finish           String?
  colorCode        String?
  imageUrl         String?
  isActive         Boolean     @default(true)
  catalogueId      String
  categoryId       String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  stockStatus      String?
  certification    String?
  colorChoice      String?
  decor            String?
  defaultThickness Float?
  isVariableLength Boolean     @default(false)
  manufacturerRef  String?
  pricePerMl       Float?
  pricePerUnit     Float?
  productType      String?
  stockLocations   String?
  supplierCode     String?
  supportQuality   String?
  metadata         String?
  devisLines       DevisLine[]
  catalogue        Catalogue   @relation(fields: [catalogueId], references: [id], onDelete: Cascade)
  category         Category?   @relation(fields: [categoryId], references: [id])

  @@unique([catalogueId, reference])
  @@index([catalogueId])
  @@index([reference])
  @@index([name])
  @@index([isActive])
  @@index([categoryId])
  @@index([catalogueId, isActive])
  @@index([finish])
}

model Devis {
  id             String        @id @default(cuid())
  reference      String        @unique
  name           String?
  status         DevisStatus   @default(DRAFT)
  clientName     String?
  clientEmail    String?
  clientPhone    String?
  clientAddress  String?
  totalHT        Float         @default(0)
  totalTVA       Float         @default(0)
  totalTTC       Float         @default(0)
  tvaRate        Float         @default(20)
  notes          String?
  validUntil     DateTime?
  userId         String
  organizationId String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization? @relation(fields: [organizationId], references: [id])
  user           User          @relation(fields: [userId], references: [id])
  lines          DevisLine[]
  order          Order?

  @@index([userId])
  @@index([reference])
  @@index([status])
}

model DevisLine {
  id             String   @id @default(cuid())
  panelReference String
  panelName      String
  thickness      Float
  length         Int
  width          Int
  quantity       Int      @default(1)
  chantHaut      String?
  chantBas       String?
  chantGauche    String?
  chantDroit     String?
  unitPriceHT    Float
  totalHT        Float
  position       Int      @default(0)
  devisId        String
  panelId        String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  devis          Devis    @relation(fields: [devisId], references: [id], onDelete: Cascade)
  panel          Panel?   @relation(fields: [panelId], references: [id])

  @@index([devisId])
}

model Order {
  id                String        @id @default(cuid())
  reference         String        @unique
  status            OrderStatus   @default(PENDING)
  totalHT           Float
  totalTVA          Float
  totalTTC          Float
  stripePaymentId   String?
  paidAt            DateTime?
  deliveryAddress   String?
  deliveryNotes     String?
  estimatedDelivery DateTime?
  deliveredAt       DateTime?
  userId            String
  organizationId    String?
  devisId           String        @unique
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  devis             Devis         @relation(fields: [devisId], references: [id])
  organization      Organization? @relation(fields: [organizationId], references: [id])
  user              User          @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([reference])
  @@index([status])
}

model PanneauMulticoucheTemplate {
  id              String   @id @default(cuid())
  nom             String
  description     String?
  modeCollage     String
  couches         String
  epaisseurTotale Float
  prixEstimeM2    Float
  userId          String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model CutxImportSession {
  id              String    @id @default(cuid())
  data            String
  projectName     String?
  sketchupVersion String?
  pluginVersion   String?
  ipAddress       String?
  expiresAt       DateTime
  usedAt          DateTime?
  createdAt       DateTime  @default(now())

  @@index([expiresAt])
  @@index([createdAt])
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum PlanType {
  FREE
  PRO
  ENTERPRISE
}

enum DevisStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
  CONVERTED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}
