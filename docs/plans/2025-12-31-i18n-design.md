# Design i18n CutX Configurateur

> Date: 2025-12-31
> Status: Validated
> Scope: MVP - Client configurateur FR/EN

## 1. Contexte

Internationalisation du configurateur CutX pour supporter l'anglais (EN) en plus du français (FR) existant. Approche MVP rapide ciblant les professionnels anglophones internationaux.

## 2. Décisions

| Aspect | Choix |
|--------|-------|
| **Cible** | International généraliste (tous anglophones) |
| **Données produits** | Noms fabricants conservés, descriptions traduites |
| **Unités** | Toggle mm/pouces indépendant (stockage BDD en mm) |
| **Lib i18n** | `next-intl` |
| **Détection langue** | Auto navigateur + fallback FR + sélecteur manuel |
| **Persistance** | Cookie/localStorage + Clerk metadata (connectés) |
| **UI Switcher** | Dropdown header (langue + unités) |
| **Fichiers trad** | Par namespace (common, configurateur, dialogs, products) |
| **Traductions EN** | Claude génère, utilisateur valide |
| **Scope MVP** | Configurateur client uniquement |

## 3. Architecture

```
cutx-frontend/
├── src/
│   ├── app/
│   │   └── [locale]/                 # Routing dynamique FR/EN
│   │       ├── layout.tsx
│   │       ├── page.tsx
│   │       └── configurateur/
│   │           └── page.tsx
│   ├── components/
│   │   └── ui/
│   │       └── LocaleSwitcher.tsx    # Dropdown header
│   ├── i18n/
│   │   ├── request.ts                # Config next-intl
│   │   ├── routing.ts                # Définition locales
│   │   └── utils.ts                  # Helpers conversion mm↔pouces
│   ├── messages/
│   │   ├── fr/
│   │   │   ├── common.json
│   │   │   ├── configurateur.json
│   │   │   ├── dialogs.json
│   │   │   └── products.json
│   │   └── en/
│   │       └── ... (même structure)
│   └── hooks/
│       └── useUnits.ts               # Hook gestion mm/pouces
├── middleware.ts                      # Détection locale + Clerk
└── next.config.ts                     # Plugin next-intl
```

## 4. Configuration next-intl

### routing.ts

```typescript
import { defineRouting } from 'next-intl/routing';

export const routing = defineRouting({
  locales: ['fr', 'en'],
  defaultLocale: 'fr',
  localePrefix: 'always'
});
```

### request.ts

```typescript
import { getRequestConfig } from 'next-intl/server';
import { routing } from './routing';

export default getRequestConfig(async ({ requestLocale }) => {
  let locale = await requestLocale;
  if (!locale || !routing.locales.includes(locale)) {
    locale = routing.defaultLocale;
  }

  return {
    locale,
    messages: {
      ...(await import(`../messages/${locale}/common.json`)).default,
      ...(await import(`../messages/${locale}/configurateur.json`)).default,
      ...(await import(`../messages/${locale}/dialogs.json`)).default,
      ...(await import(`../messages/${locale}/products.json`)).default,
    }
  };
});
```

### middleware.ts

```typescript
import createMiddleware from 'next-intl/middleware';
import { clerkMiddleware } from '@clerk/nextjs/server';
import { routing } from './src/i18n/routing';

const intlMiddleware = createMiddleware(routing);

export default clerkMiddleware((auth, req) => {
  return intlMiddleware(req);
});

export const config = {
  matcher: ['/((?!api|_next|.*\\..*).*)']
};
```

## 5. Système d'unités mm ↔ pouces

### useUnits.ts

```typescript
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

type UnitSystem = 'mm' | 'in';

interface UnitsState {
  unit: UnitSystem;
  setUnit: (unit: UnitSystem) => void;
  toDisplay: (mm: number) => number;
  toMm: (value: number) => number;
  formatDimension: (mm: number) => string;
}

export const useUnits = create<UnitsState>()(
  persist(
    (set, get) => ({
      unit: 'mm',
      setUnit: (unit) => set({ unit }),

      toDisplay: (mm) => {
        if (get().unit === 'in') return mm / 25.4;
        return mm;
      },

      toMm: (value) => {
        if (get().unit === 'in') return value * 25.4;
        return value;
      },

      formatDimension: (mm) => {
        const { unit, toDisplay } = get();
        const val = toDisplay(mm);
        if (unit === 'in') {
          return `${val.toFixed(2)}″`;
        }
        return `${Math.round(val)} mm`;
      },
    }),
    { name: 'cutx-units' }
  )
);
```

## 6. Composant LocaleSwitcher

```tsx
'use client';

import { useLocale, useTranslations } from 'next-intl';
import { useRouter, usePathname } from 'next/navigation';
import { useUnits } from '@/hooks/useUnits';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Globe, Ruler } from 'lucide-react';

export function LocaleSwitcher() {
  const locale = useLocale();
  const router = useRouter();
  const pathname = usePathname();
  const { unit, setUnit } = useUnits();

  const switchLocale = (newLocale: string) => {
    const newPath = pathname.replace(`/${locale}/`, `/${newLocale}/`);
    router.push(newPath);
  };

  return (
    <div className="flex items-center gap-2">
      <Select value={locale} onValueChange={switchLocale}>
        <SelectTrigger className="w-[100px]">
          <Globe className="h-4 w-4 mr-1" />
          <SelectValue />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="fr">FR</SelectItem>
          <SelectItem value="en">EN</SelectItem>
        </SelectContent>
      </Select>

      <Select value={unit} onValueChange={(v) => setUnit(v as 'mm' | 'in')}>
        <SelectTrigger className="w-[80px]">
          <Ruler className="h-4 w-4 mr-1" />
          <SelectValue />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="mm">mm</SelectItem>
          <SelectItem value="in">inch</SelectItem>
        </SelectContent>
      </Select>
    </div>
  );
}
```

## 7. Sync Clerk (utilisateurs connectés)

```typescript
// src/lib/clerk-preferences.ts
import { useUser } from '@clerk/nextjs';

interface UserPreferences {
  locale: 'fr' | 'en';
  unit: 'mm' | 'in';
}

export function useSyncPreferences() {
  const { user } = useUser();

  const saveToClerk = async (prefs: Partial<UserPreferences>) => {
    if (!user) return;

    await user.update({
      unsafeMetadata: {
        ...user.unsafeMetadata,
        preferences: {
          ...(user.unsafeMetadata?.preferences as any || {}),
          ...prefs
        }
      }
    });
  };

  const loadFromClerk = (): UserPreferences | null => {
    if (!user) return null;
    return user.unsafeMetadata?.preferences as UserPreferences || null;
  };

  return { saveToClerk, loadFromClerk };
}
```

## 8. Structure des fichiers de traduction

### messages/fr/common.json

```json
{
  "save": "Enregistrer",
  "cancel": "Annuler",
  "delete": "Supprimer",
  "add": "Ajouter",
  "search": "Rechercher",
  "loading": "Chargement...",
  "error": "Une erreur est survenue",
  "success": "Opération réussie"
}
```

### messages/fr/configurateur.json

```json
{
  "title": "Configurateur de découpe",
  "addLine": "Ajouter une ligne",
  "columns": {
    "reference": "Référence",
    "panel": "Panneau",
    "dimensions": "Dimensions (L × l × ép)",
    "edges": "Chants",
    "finish": "Finition",
    "quantity": "Qté",
    "priceHT": "Prix HT"
  },
  "placeholders": {
    "reference": "Réf: Débit 1",
    "searchPanel": "Rechercher un panneau..."
  },
  "summary": {
    "totalHT": "Total HT",
    "totalTTC": "Total TTC",
    "orderMinimum": "Minimum de commande : {amount} €"
  }
}
```

## 9. Plan d'implémentation

| Phase | Tâches | Effort |
|-------|--------|--------|
| **1. Infrastructure** | Install next-intl, config, middleware, routing [locale] | 2h |
| **2. Traductions** | Créer fichiers JSON FR + EN | 2h |
| **3. UI** | Hook useUnits, LocaleSwitcher | 1h |
| **4. Migration** | Remplacer textes hardcodés dans composants | 4h |
| **5. Finalisation** | Clerk sync, tests | 1h |

**Total estimé : ~10h**

## 10. Exclusions MVP

- Emails/notifications
- PDF/exports
- Admin/backoffice
- Autres langues (ES, DE...)

## 11. Flux utilisateur

```
Arrivée ──► Middleware détecte Accept-Language ──► Redirect /fr/ ou /en/
    │
    ▼
Navigation ──► URL reflète la langue (/en/configurateur)
    │
    ▼
Switch manuel ──► Dropdown header ──► Cookie + Redirect
    │
    ▼
Login Clerk ──► Charge prefs depuis metadata ──► Sync multi-appareils
```
